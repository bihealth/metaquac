```{r, message=FALSE, warning=FALSE, include=FALSE}

# Prettify warnings etc. in notebook
# Source: https://selbydavid.com/2017/06/18/rmarkdown-alerts/
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^#*\ *Error', '**Error:**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^#*\ *Warning:', '**Warning:**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     if (grepl(pattern = '^#*\ *Error:', x = x)){
       paste('\n\n<div class="alert alert-danger">',
             gsub('##', '\n', gsub('^#*\ *Error', '**Error:**', x)),
             '</div>', sep = '\n')
     } else if (grepl(pattern = '^#*\ *Warning:', x = x)){
       paste('\n\n<div class="alert alert-warning">',
             gsub('##', '\n', gsub('^#*\ *Warning:', '**Warning:**', x)),
             '</div>', sep = '\n')
     } else if (grepl(pattern = '^#*\ *Success:', x = x)){
       paste('\n\n<div class="alert alert-success">',
             gsub('##', '\n', gsub('^#*\ *Success:', '', x)),
             '</div>', sep = '\n')
     } else {
       paste('\n\n<div class="alert alert-info">',
             gsub('##', '\n', x),
             '</div>', sep = '\n')
     }
   }
)


# Parse and validate parameters

# Data files
if ("data_files" %in% names(params)){
  assert_that(class(params$data_files) == "list")
}

# Regex sample filter need to be one string
if ("filter_regex" %in% names(params)){
  assert_that(class(params$filter_regex) == "character" &&
                length(params$filter_regex) == 1)
}

# Study_variables needs to be a list, including only lists and strings
if ("study_variables" %in% names(params)){
  STUDY_VARIABLES <- params$study_variables
  is_lists_and_strings <- function(l){
    all(lapply(l, function(x){if(is.list(x)){ is_lists_and_strings(x) } else if (is.character(x)) { TRUE  } else { FALSE }}))
  }
  if (length(STUDY_VARIABLES) > 0){
    assert_that(class(STUDY_VARIABLES) == "list")
    if(!is_lists_and_strings(STUDY_VARIABLES)){
      stop(paste(
        "Invalid data in study variables (use strings or named lists of strings):\n",
        paste(dput(STUDY_VARIABLES), collapse = ", ")))
    }
  }
}

# profiling_variables needs to be a vector, including only strings
if ("profiling_variables" %in% names(params)){
  PROFILING_VARIABLES <- params$profiling_variables
  if (length(PROFILING_VARIABLES) > 0){
    assert_that(class(PROFILING_VARIABLES) == "character")
  }
}

# replicate_variables needs to be a vector, including only strings
if ("replicate_variables" %in% names(params)){
  REPLICATE_VARIABLES <- params$replicate_variables
  if (length(REPLICATE_VARIABLES) > 0){
    assert_that(class(REPLICATE_VARIABLES) == "character")
  }
}

# Pool indicator needs to be one string (column name)
if ("pool_indicator" %in% names(params)){
  POOL_INDICATOR <- params$pool_indicator
  if (is.na(POOL_INDICATOR) || is.null(POOL_INDICATOR) || POOL_INDICATOR == ""){
    POOL_INDICATOR <- "Sample.Identification"
  }
  else {
    assert_that(class(POOL_INDICATOR) == "character" &&
                  length(POOL_INDICATOR) == 1)
  }
} else {
  POOL_INDICATOR <- "Sample.Identification"
}

# Additional normalization supported: None, PQN
if ("additional_normalization" %in% names(params)){
  assert_that(params$additional_normalization %in% c("None", "PQN"))
}

# Kit selection
if ("kit" %in% names(params)){
  assert_that(params$kit %in% KITS)
} else {
  stop(paste0(
        "No kit selected. Currently supported: '",
        paste(KITS, collapse = "', '"), "'"))
}

# MetIDQ statuses
assertthat::assert_that("preproc_keep_status" %in% names(params))
assertthat::assert_that(all(params$preproc_keep_status %in% METIDQ_STATUSES))

# Filter thresholds
if (!is.null(params$filter_compound_qc_max_mv_ratio)) {
  assertthat::assert_that(
    0 <= params$filter_compound_qc_max_mv_ratio && params$filter_compound_qc_max_mv_ratio <= 1
  )
}
if (!is.null(params$filter_compound_qc_max_rsd)) {
  assertthat::assert_that(
    0 <= params$filter_compound_qc_max_rsd && params$filter_compound_qc_max_rsd <= 100
  )
}
if (!is.null(params$filter_compound_bs_max_mv_ratio)) {
  assertthat::assert_that(
    0 <= params$filter_compound_bs_max_mv_ratio && params$filter_compound_bs_max_mv_ratio <= 1
  )
}
if (!is.null(params$filter_sample_max_mv_ratio)) {
  assertthat::assert_that(
    0 <= params$filter_sample_max_mv_ratio && params$filter_sample_max_mv_ratio <= 1
  )
}
```
