---
output:
  html_notebook:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: true
    number_sections: true  
    df_print: paged
params:
  # Data files as exported by MetIDQ (txt), indicated as an R list providing the
  # files per batch via named vectors. E.g. list(Batch1 = c("Batch1_LC1.txt", "Batch1_LC2.txt"),
  # Batch2 = c("Batch2_LC1.txt","Batch2_LC2.txt")).
  data_files:
  # The Biocrates Kit used to create the data to import. Currently supported are
  # "Biocrates AbsoluteIDQ p400 HR Kit" and "Biocrates MxP Quant 500 Kit" (default =
  # "Biocrates AbsoluteIDQ p400 HR Kit").
  kit: Biocrates AbsoluteIDQ p400 HR Kit
  # The measurement type (i.e. injection type) of the data to import, i.e.
  # either "LC" or "FIA" (default = "LC").
  measurement_type: LC
  # Custom title for report (default = "Biocrates QC Report").
  title: Biocrates QC Report
  # Name of the person responsible for creating the report.
  author: Unknown

  # Indicate a vector of study variables which will be used for profiling group sizes (i.e. number
  # of samples) within a variable, but also the size of group intersections between these variables.
  # It is recommended to keep the variables limited to factors of primary interest (for instance
  # disease status or treatment and sex), otherwise intersection might turn out really small.
  profiling_variables:

  # Indicate a list of study variables of interest. These will be used to create
  # colored versions of some plots to illustrate group differences. Nested
  # variables are possible by including named sublists, whereby plots will be
  # created based on data filtered by groups of the list-naming variable.
  study_variables:

  # Indicate a vector of study variables which donate the unique grouping of
  # samples (could be as simple as a patient identifier or several conditions).
  # Samples with the same characteristic in these variables are considered as
  # replicates for compound and class %RSD analysis plots. If the data contains
  # "BR" and "TR" columns these plots will be extended for technical replicates.
  replicate_variables:

  # Provide a column/variable name which should be scanned for pooled QC samples.
  # All samples with "pool" (case insensitive) in this column a transformed to
  # Sample.Type = "Pooled QC". Default column is "Sample.Identification"
  # Note: Replace spaces (" ") with dots (".") in the column name.
  pool_indicator: Sample.Identification

  # Indicate which values are acceptable for processing with
  # respect to Biocrates statuses. The default includes only "Valid" measurements, the rest
  # is discarded as missing values (i.e. set to NA). Possible statuses to select from
  # include "Valid", "Smaller Zero", "< LOD", "< LLOQ", "> ULOQ", "No Intercept",
  # "Missing Measurement", "ISTD Out of Range", "STD/QC < Limit", "STD/QC > Limit",
  # "Invalid", "Incomplete" and "Blank Out of Range".
  preproc_keep_status: "Valid"

  # Set thresholds for maximum ratio of missing values allowed for compounds in reference QC
  # samples (Biocrates' QC Level 2) (default 0.3, exclusive, disable with NULL), maximum %RSD
  # allowed for compounds in reference QC samples (Biocrates' QC Level 2) (default 15, exclusive,
  # disable with NULL), maximum ratio of missing values allowed for compounds in biological samples
  # (Biocrates' Sample) (default 0.3, exclusive, disable with NULL), minimum \%RSD allowed for
  # compounds in biological samples (default = 15\%, exclusive, disable with NULL) and maximum ratio
  # of missing values allowed per biological sample (Biocrates' Sample) (default 0.2, exclusive,
  # disable with NULL).
  filter_compound_qc_max_mv_ratio: 0.3
  filter_compound_qc_max_rsd: 15
  filter_compound_bs_max_mv_ratio: 0.3
  filter_compound_bs_min_rsd: 15
  filter_sample_max_mv_ratio: 0.2

  # Control data tables availability in reports. "all" (default) will show all
  # implemented data tables (with vcs export buttons). "stats" will only show tables of summarized
  # data (such as countings, %RSDs, etc.), but not the actual measurements (neither original nor
  # pre-processed). "none" will show no data tables at all, i.e. the report is mainly limited to
  # visualizations.
  data_tables: all

  # [WIP] Optional additional normalization for biological samples (CURRENTLY DISABLED)
  # Currently either PQN or None
  # (not visibly passed via create_report function, yet)
  additional_normalization: None
  # Sample types used to create the reference sample for PQN (via median)
  # (not visibly passed via create_report function, yet)
  pqn_reference_type: Sample

  # [WIP] Directory and filename for the export of the processed dataset
  # export_dir: "."
  # export_name: "data_export"

  # [WIP] A regex string to filter/exclude samples directly after import
  sample_filter: ""

  # [WIP] Optional meta data preprocessing
  # Extraction of meta data from a character column
  # (not visibly passed via create_report function, yet)
  metadata_extraction:

  # Whether zeros in the data should be treated as missing values
  # (not visibly passed via create_report function, yet)
  zero2na: true
  # Whether report rendering should try to continue on errors
  # (not visibly passed via create_report function, switch for debugging only)
  ignore_errors: true
title: "`r params$title`"
author: "`r params$author`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  error = params$ignore_errors,
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
  # out.width = "100%"
)
knitr::opts_knit$set(
  eval.after = 'fig.cap'
)

# Set chunk/code evaluation control variables defaults
CONTINUE <- TRUE
MULTIBATCH <- FALSE
AVAILABLE_BIOLOGICAL <- FALSE
AVAILABLE_POOLED_QC <- FALSE
AVAILABLE_REFERENCE_QC <- FALSE
ENOUGH_BIOLOGICAL <- FALSE
ENOUGH_POOLED_QC <- FALSE
ENOUGH_REFERENCE_QC <- FALSE
NORMALIZED <- FALSE
```

```{r child="nbc_setup.Rmd"}
```

This report was created with [MeTaQuaC](https://github.com/bihealth/MeTAQuaC)
v`r packageVersion("metaquac")`.

The data as imported, restructured and preprocessed in this report is available for export in the
section [Preprocessing](#preprocessing) (via the full data tables provided for each preprocessing
step).

Before reading and interpreting this QC report, please make sure to be familiar with the Biocrates
kit used, i.e. familiarize your self with the compounds, sample types, status values, terminology,
analytical specification, etc.  
Please refer to Biocrates' manuals and documents provided with the kit used.


# Data Preparation
```{r child="nbc_import.Rmd"}
```

```{r child="nbc_metadata.Rmd", eval=CONTINUE}
```

```{r child="nbc_data_restructuring.Rmd", eval=CONTINUE}
```


# Overview
```{r child="nbc_import_info.Rmd", eval=CONTINUE}
```

```{r child="nbc_overview_profiling.Rmd", eval=CONTINUE}
```


# Preprocessing {.tabset #preprocessing}
```{r child="nbc_preprocessing.Rmd", eval=CONTINUE}
```


# Quality Control
```{r child="nbc_qc.Rmd", eval=CONTINUE}
```

```{r child="nbc_qc_compound_variability.Rmd", eval=CONTINUE}
```

```{r child="nbc_qc_rsd.Rmd", eval=CONTINUE}
```

```{r child="nbc_calibration_scatter.Rmd", eval=CONTINUE}
```


# Multivariate Visualization
```{r child="nbc_multivariate_visualization.Rmd", eval=CONTINUE}
```


# Miscellaneous
```{r child="nbc_misc_add_figures.Rmd", eval=CONTINUE}
```

<!-- Currently disabled, as data is available for export in the preprocessing section. -->
<!-- Might re-enable later with a parameter to allow for automated data extraction in pipelines. -->
```{r child="nbc_misc_export.Rmd", eval=FALSE}
```

```{r child="nbc_misc_environment.Rmd", eval=TRUE}
```
